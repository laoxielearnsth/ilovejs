<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>画图功能的实现</title>
    <style>
        #wrap {
            position: relative;
            left: 40px;
            cursor: move;
        }
        #wrap * {
            position: absolute;
        }
    </style>
</head>
<body>
<button id="btn">edit img</button>
<button id="btn2">merge img</button>

<button>撤销</button>
<button>前进</button>

<div id="wrap" draggable="true">
    <img src="" alt="" id="img">
    <canvas id="cav"></canvas>
</div>
<div id="show"></div>
<script>
    const imgUrl = 'https://91happy.oss-cn-shenzhen.aliyuncs.com/imgs/k.png?x-oss-process=style/mini';
    let btn = document.getElementById('btn');
    let btn2 = document.getElementById('btn2');
    let img = document.getElementById('img');
    let wrap = document.getElementById('wrap');

    let cav = document.getElementById('cav');
    let ctx = cav.getContext('2d');
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 13;
    ctx.lineJoin = "round";

    let editMode = false;
    let offsetx, offsety;

    let mousePressed = false;
    let lastX, lastY;
    let history = [];

    img.setAttribute('crossOrigin', 'anonymous');
    img.src = imgUrl;
    
    btn.onclick = function () {
        editMode = !editMode;

        if (editMode === false) {
            wrap.draggable = true;
            btn.innerText = "edit img";
        } else {
            wrap.draggable = false;
            btn.innerText = "editing";
        }
    };

    img.onload = function () {
        cav.width = img.width;
        cav.height = img.height;
        wrap.style.width = img.width;
        wrap.style.height = img.height;
        ctx.font = '48px serif';
        ctx.fillText('im in love with her body', 10, 50);
    };

    wrap.ondragstart = function (ev) {
        let img = new Image();
        img.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' %3E%3Cpath /%3E%3C/svg%3E';
        ev.dataTransfer.setDragImage(img, 0, 0);
        if (editMode) return;
        offsetx = ev.offsetX;
        offsety = ev.offsetY;
    };

    wrap.ondrag = function (ev) {
        if (editMode) return;

        let x = ev.pageX,
            y = ev.pageY;

        if (x === 0, y === 0) return;

        x -= offsetx;
        y -= offsety;

        // wrap.style.transform = `translate(${x}px,${y}px)`;
        wrap.style.left = `${x}px`;
        wrap.style.top = `${y}px`;
        //todo drag移除处理等
    };

    //todo 编辑mode
    wrap.onmousedown = function (ev) {
        // ev.preventDefault();
        if (!editMode) return;
        mousePressed = true;
        draw(ev.offsetX, ev.offsetY, false);
    };

    wrap.onmousemove = function (ev) {
        if (!editMode) return;
        if (mousePressed) {
            draw(ev.offsetX, ev.offsetY, true);
        }
    };

    wrap.onmouseup = function (ev) {
        if (!editMode) return;
        mousePressed = false;
    };

    wrap.onmouseleave = function () {
        if (!editMode) return;
        mousePressed = false
    };

    function draw(x, y, isDown) {
        if (isDown) {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.closePath();
            ctx.stroke();
        }
        lastX = x;
        lastY = y;
    }

    btn2.onclick = function () {
        let backimg = document.createElement('canvas');
        backimg.width = img.width;
        backimg.height = img.height;
        let bacctx = backimg.getContext('2d');

        bacctx.drawImage(img, 0, 0);

        bacctx.drawImage(cav, 0, 0);

        let dataUri = backimg.toDataURL('image/jpeg');
        console.log(dataUri);
    }
</script>
</body>
</html>